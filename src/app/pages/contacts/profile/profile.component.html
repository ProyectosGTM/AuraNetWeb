<div class="container-fluid profile-page" *ngIf="user" [@fadeInRight]>
  <div class="row">
    <div class="col-12">
      <div class="profile-wrapper">
        <!-- Hero + Avatar -->
        <div class="profile-hero">
          <div class="hero-bg"></div>
          <div class="hero-content">
            <div class="avatar-section">
              <div class="avatar-container">
                <img *ngIf="fotoPerfilUrl" [src]="'https://transmovi.s3.us-east-2.amazonaws.com/imagenes/user_default.png'" [alt]="nombreCompleto" class="avatar-img" />
                <div *ngIf="!fotoPerfilUrl" class="avatar-placeholder">
                  <i class="fas fa-user"></i>
                </div>
                <div class="avatar-ring"></div>
              </div>
              <h1 class="profile-name">{{ nombreCompleto }}</h1>
              <p class="profile-email">
                <i class="fas fa-envelope"></i>
                {{ user.userName || user.email || '—' }}
              </p>
              <div class="profile-badge">{{ nombreClienteCompleto }}</div>
            </div>
          </div>
        </div>

        <!-- Info Cards Grid -->
        <div class="profile-info-grid">
          <div class="row g-3">
            <div class="col-12 col-sm-6 col-lg-4">
              <div class="info-card info-card-primary">
                <div class="info-card-icon">
                  <i class="fas fa-id-badge"></i>
                </div>
                <div class="info-card-body">
                  <span class="info-label">ID de usuario</span>
                  <span class="info-value">{{ user.id || '—' }}</span>
                </div>
              </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-4">
              <div class="info-card info-card-info">
                <div class="info-card-icon">
                  <i class="fas fa-phone"></i>
                </div>
                <div class="info-card-body">
                  <span class="info-label">Teléfono</span>
                  <span class="info-value">{{ user.telefono && user.telefono !== 'null' ? user.telefono : 'No registrado' }}</span>
                </div>
              </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-4">
              <div class="info-card info-card-success">
                <div class="info-card-icon">
                  <i class="fas fa-building"></i>
                </div>
                <div class="info-card-body">
                  <span class="info-label">Organización</span>
                  <span class="info-value">{{ nombreClienteCompleto }}</span>
                </div>
              </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-6">
              <div class="info-card info-card-warning">
                <div class="info-card-icon">
                  <i class="fas fa-calendar-plus"></i>
                </div>
                <div class="info-card-body">
                  <span class="info-label">Fecha de registro</span>
                  <span class="info-value">{{ fechaCreacionFormateada }}</span>
                </div>
              </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-6">
              <div class="info-card info-card-danger">
                <div class="info-card-icon">
                  <i class="fas fa-sign-in-alt"></i>
                </div>
                <div class="info-card-body">
                  <span class="info-label">Último acceso</span>
                  <span class="info-value">{{ ultimoLoginFormateado }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Acciones -->
        <div class="profile-actions">
          <div class="row g-3">
            <div class="col-12">
              <button type="button"
                class="action-btn action-btn-key"
                [class.action-btn-active]="mostrarPanelContrasena"
                (click)="togglePanelContrasena()">
                <span class="action-icon">
                  <i class="fas" [class.fa-key]="!mostrarPanelContrasena" [class.fa-times]="mostrarPanelContrasena"></i>
                </span>
                <span class="action-text">
                  {{ mostrarPanelContrasena ? 'Cerrar' : 'Cambiar contraseña' }}
                </span>
                <span class="action-arrow" [class.rotated]="mostrarPanelContrasena">
                  <i class="fas fa-chevron-down"></i>
                </span>
              </button>
            </div>
          </div>

          <!-- Panel de cambio de contraseña - Solo visible al presionar -->
          <div *ngIf="mostrarPanelContrasena" class="password-panel" [@slideDownFade]>
            <div class="password-panel-inner">
              <div class="password-panel-header">
                <div class="password-panel-icon">
                  <i class="fas fa-lock"></i>
                </div>
                <div>
                  <h4 class="password-panel-title">Actualizar contraseña</h4>
                  <p class="password-panel-subtitle">Ingresa tu contraseña actual y la nueva contraseña que deseas usar</p>
                </div>
              </div>

              <form [formGroup]="passwordForm" (ngSubmit)="guardarContrasena()" class="password-form">
                <div class="form-group-password">
                  <label for="contraseñaActual">
                    <i class="fas fa-key"></i>
                    Contraseña actual
                  </label>
                  <div class="input-wrapper">
                    <input
                      id="contraseñaActual"
                      [type]="showCurrentPassword ? 'text' : 'password'"
                      formControlName="contraseñaActual"
                      placeholder="••••••••"
                      class="password-input"
                      autocomplete="current-password" />
                    <button type="button" class="toggle-visibility" (click)="showCurrentPassword = !showCurrentPassword" tabindex="-1">
                      <i class="fas" [class.fa-eye]="!showCurrentPassword" [class.fa-eye-slash]="showCurrentPassword"></i>
                    </button>
                  </div>
                  <span class="field-error" *ngIf="passwordForm.get('contraseñaActual')?.invalid && passwordForm.get('contraseñaActual')?.touched">
                    Mínimo 6 caracteres
                  </span>
                </div>

                <div class="form-group-password">
                  <label for="nuevaContrasena">
                    <i class="fas fa-shield-alt"></i>
                    Nueva contraseña
                  </label>
                  <div class="input-wrapper">
                    <input
                      id="nuevaContrasena"
                      [type]="showNewPassword ? 'text' : 'password'"
                      formControlName="nuevaContrasena"
                      placeholder="••••••••"
                      class="password-input"
                      autocomplete="new-password" />
                    <button type="button" class="toggle-visibility" (click)="showNewPassword = !showNewPassword" tabindex="-1">
                      <i class="fas" [class.fa-eye]="!showNewPassword" [class.fa-eye-slash]="showNewPassword"></i>
                    </button>
                  </div>
                  <span class="field-error" *ngIf="passwordForm.get('nuevaContrasena')?.invalid && passwordForm.get('nuevaContrasena')?.touched">
                    Mínimo 6 caracteres
                  </span>
                </div>

                <div class="form-group-password">
                  <label for="confirmarContrasena">
                    <i class="fas fa-check-double"></i>
                    Confirmar contraseña
                  </label>
                  <div class="input-wrapper">
                    <input
                      id="confirmarContrasena"
                      [type]="showConfirmPassword ? 'text' : 'password'"
                      formControlName="confirmarContrasena"
                      placeholder="••••••••"
                      class="password-input"
                      autocomplete="new-password" />
                    <button type="button" class="toggle-visibility" (click)="showConfirmPassword = !showConfirmPassword" tabindex="-1">
                      <i class="fas" [class.fa-eye]="!showConfirmPassword" [class.fa-eye-slash]="showConfirmPassword"></i>
                    </button>
                  </div>
                  <span class="field-error" *ngIf="passwordForm.hasError('passwordMismatch') && passwordForm.get('confirmarContrasena')?.touched">
                    Las contraseñas no coinciden
                  </span>
                </div>

                <div class="password-form-actions">
                  <button type="button" class="btn-cancelar" (click)="togglePanelContrasena()">
                    Cancelar
                  </button>
                  <button type="submit" class="btn-guardar" [disabled]="cambiandoContrasena">
                    <span *ngIf="!cambiandoContrasena">
                      <i class="fas fa-check"></i>
                      Actualizar contraseña
                    </span>
                    <span *ngIf="cambiandoContrasena" class="loading-spinner">
                      <i class="fas fa-spinner fa-spin"></i>
                      Guardando...
                    </span>
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
