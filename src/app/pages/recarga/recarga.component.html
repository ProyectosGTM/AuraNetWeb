<div class="container-fluid recarga-page" [@fadeInRight]>
  <div class="row">
    <div class="col-12">
      <div class="title-banner-card shadow-sm">
        <div class="title-banner-content d-flex align-items-center justify-content-between flex-wrap p-1 pb-0">
          <div class="d-flex align-items-center gap-3">
            <div class="title-icon">
              <i class="fas fa-wallet"></i>
            </div>
            <div>
              <h4 class="title-title">Módulo de Recarga</h4>
              <p class="title-subtitle">
                Realiza operaciones de carga de efectivo a monederos
              </p>
            </div>
          </div>
          <div class="title-actions">
            <div class="title-tagline">
              <span class="line"></span>
              <span class="text">Carga rápida y segura</span>
            </div>
          </div>
        </div>

        <div class="row mt-5">
          <div class="col-12">
            <div [class.is-start]="!(cajaSeleccionada || monederoSeleccionado || recargaForm.get('monto')?.value)">
              <form [formGroup]="recargaForm">
                <div class="row g-3">
                  
                  <!-- 1. Flujo de Recarga (primera card, full width) -->
                  <div class="col-12">
                    <div class="rail-card rail-card--full">
                      <div class="rail-top">
                        <div class="rail-badge">
                          <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="rail-title">
                          <div class="t1">Flujo de Recarga</div>
                          <div class="t2">Selecciona, valida y confirma</div>
                        </div>
                      </div>

                      <div class="rail-steps">
                        <div class="step" [class.active]="!cajaSeleccionada">
                          <div class="dot"><span>1</span></div>
                          <div class="meta">
                            <div class="s-title">Caja</div>
                            <div class="s-sub">Elige el punto de cobro</div>
                          </div>
                          <div class="state">
                            <i class="fas fa-check" *ngIf="cajaSeleccionada"></i>
                          </div>
                        </div>

                        <div class="step" [class.active]="cajaSeleccionada && !monederoSeleccionado" [class.locked]="!cajaSeleccionada">
                          <div class="dot"><span>2</span></div>
                          <div class="meta">
                            <div class="s-title">Monedero</div>
                            <div class="s-sub">Selecciona al afiliado</div>
                          </div>
                          <div class="state">
                            <i class="fas fa-check" *ngIf="monederoSeleccionado"></i>
                          </div>
                        </div>

                        <div class="step" [class.active]="cajaSeleccionada && monederoSeleccionado && !recargaForm.get('monto')?.value" [class.locked]="!monederoSeleccionado">
                          <div class="dot"><span>3</span></div>
                          <div class="meta">
                            <div class="s-title">Monto</div>
                            <div class="s-sub">Define la carga</div>
                          </div>
                          <div class="state">
                            <i class="fas fa-check" *ngIf="recargaForm.get('monto')?.value"></i>
                          </div>
                        </div>

                        <div class="step" [class.active]="cajaSeleccionada && monederoSeleccionado && recargaForm.get('monto')?.value" [class.locked]="!recargaForm.get('monto')?.value">
                          <div class="dot"><span>4</span></div>
                          <div class="meta">
                            <div class="s-title">Confirmación</div>
                            <div class="s-sub">Revisa el resumen</div>
                          </div>
                          <div class="state">
                            <i class="fas fa-bolt" *ngIf="cajaSeleccionada && monederoSeleccionado && recargaForm.get('monto')?.value"></i>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- 2. Caja, Monedero y Monto en una fila (altura uniforme) -->
                  <div class="col-12">
                    <div class="row g-3 row-cards-equal">
                      <!-- Caja -->
                      <div class="col-12 col-md-4">
                        <div class="panel-card panel-caja h-100">
                          <div class="panel-head">
                            <div class="ph-left">
                              <div class="ph-ico ph-ico-caja">
                                <i class="fas fa-cash-register"></i>
                              </div>
                              <div class="ph-txt">
                                <div class="ph-title">Caja</div>
                                <div class="ph-sub">Selecciona la caja</div>
                              </div>
                            </div>
                          </div>

                          <div class="panel-body">
                            <div class="row g-2">
                              <div class="col-12">
                                <label class="field">
                                  <span class="field-label text-white">Caja *</span>
                                  <dx-select-box
                                    [dataSource]="listaCajas"
                                    displayExpr="text"
                                    valueExpr="id"
                                    formControlName="idCaja"
                                    placeholder="Selecciona una caja..."
                                    searchEnabled="true"
                                    searchMode="contains"
                                    [showClearButton]="true"
                                    (onValueChanged)="onCajaChanged($event)"
                                    class="dx-select-box-custom dx-select-box-caja">
                                  </dx-select-box>
                                </label>
                              </div>

                              <div class="col-12">
                                <div class="mini-chip mini-chip-caja" [class.on]="cajaSeleccionada">
                                  <i class="fas fa-warehouse"></i>
                                  <span>{{ cajaSeleccionada ? 'Caja lista' : 'Pendiente' }}</span>
                                </div>
                              </div>
                            </div>

                            <div class="detail-strip" *ngIf="cajaSeleccionada" [@slideDownFade] [@staggerFadeIn]>
                              <div class="ditem">
                                <div class="dlabel"><i class="fas fa-building"></i> Sala</div>
                                <div class="dvalue">{{ cajaSeleccionada.nombreSala || 'Sin registro' }}</div>
                              </div>
                              <div class="ditem">
                                <div class="dlabel"><i class="fas fa-map-marker-alt"></i> Zona</div>
                                <div class="dvalue">{{ cajaSeleccionada.nombreZona || 'Sin registro' }}</div>
                              </div>
                              <div class="ditem">
                                <div class="dlabel"><i class="fas fa-barcode"></i> Código</div>
                                <div class="dvalue">{{ cajaSeleccionada.codigo || 'Sin registro' }}</div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Monedero -->
                      <div class="col-12 col-md-4">
                        <div class="panel-card panel-monedero h-100">
                          <div class="panel-head">
                            <div class="ph-left">
                              <div class="ph-ico ph-ico-monedero">
                                <i class="fas fa-wallet"></i>
                              </div>
                              <div class="ph-txt">
                                <div class="ph-title">Monedero</div>
                                <div class="ph-sub">Selecciona el monedero a recargar</div>
                              </div>
                            </div>
                          </div>

                          <div class="panel-body">
                            <div class="row g-2">
                              <div class="col-12">
                                <label class="field">
                                  <span class="field-label text-white">Monedero *</span>
                                  <dx-select-box
                                    [dataSource]="listaMonederos"
                                    displayExpr="text"
                                    valueExpr="id"
                                    formControlName="idMonedero"
                                    placeholder="Selecciona un monedero..."
                                    searchEnabled="true"
                                    searchMode="contains"
                                    [showClearButton]="true"
                                    (onValueChanged)="onMonederoChanged($event)"
                                    class="dx-select-box-custom dx-select-box-monedero">
                                  </dx-select-box>
                                </label>
                              </div>

                              <div class="col-12">
                                <div class="mini-chip mini-chip-monedero" [class.on]="monederoSeleccionado">
                                  <i class="fas fa-user-check"></i>
                                  <span>{{ monederoSeleccionado ? 'Afiliado listo' : 'Pendiente' }}</span>
                                </div>
                              </div>
                            </div>

                            <div class="detail-strip" *ngIf="monederoSeleccionado" [@slideDownFade] [@staggerFadeIn]>
                              <div class="ditem">
                                <div class="dlabel"><i class="fas fa-barcode"></i> Número</div>
                                <div class="dvalue">{{ monederoSeleccionado.numeroMonedero || 'Sin registro' }}</div>
                              </div>
                              <div class="ditem">
                                <div class="dlabel"><i class="fas fa-tag"></i> Alias</div>
                                <div class="dvalue">{{ monederoSeleccionado.alias || 'Sin registro' }}</div>
                              </div>
                              <div class="ditem">
                                <div class="dlabel"><i class="fas fa-user"></i> Afiliado</div>
                                <div class="dvalue">{{ monederoSeleccionado.nombreCompletoAfiliado || 'Sin registro' }}</div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Monto -->
                      <div class="col-12 col-md-4">
                        <div class="panel-card panel-monto h-100">
                          <div class="panel-head">
                            <div class="ph-left">
                              <div class="ph-ico ph-ico-monto">
                                <i class="fas fa-coins"></i>
                              </div>
                              <div class="ph-txt">
                                <div class="ph-title">Monto</div>
                                <div class="ph-sub">Ingresa el monto a cargar</div>
                              </div>
                            </div>

                          </div>

                          <div class="panel-body">
                            <div class="row g-2">
                              <div class="col-12">
                                <label class="field">
                                  <span class="field-label text-white">Monto *</span>
                                  <div class="input-sleek input-monto">
                                    <i class="fas fa-dollar-sign"></i>
                                    <input [value]="montoDisplay" class="sleek-control" type="text" inputmode="decimal" placeholder="0.00" (focus)="montoFocused = true" (input)="onMontoInput($event)" (blur)="onMontoBlur($event)" />
                                    <span class="sleek-line"></span>
                                  </div>
                                </label>
                              </div>

                              <div class="col-12">
                                <div class="quick-grid">
                                  <button type="button" class="qbtn" (click)="setMontoRapido(100)">
                                    <span class="qtop"><i class="fas fa-hand-holding-usd"></i></span>
                                    <span class="qval">$100</span>
                                  </button>
                                  <button type="button" class="qbtn" (click)="setMontoRapido(500)">
                                    <span class="qtop"><i class="fas fa-hand-holding-usd"></i></span>
                                    <span class="qval">$500</span>
                                  </button>
                                  <button type="button" class="qbtn" (click)="setMontoRapido(1000)">
                                    <span class="qtop"><i class="fas fa-hand-holding-usd"></i></span>
                                    <span class="qval">$1,000</span>
                                  </button>
                                  <button type="button" class="qbtn" (click)="setMontoRapido(2000)">
                                    <span class="qtop"><i class="fas fa-hand-holding-usd"></i></span>
                                    <span class="qval">$2,000</span>
                                  </button>
                                  <button type="button" class="qbtn" (click)="setMontoRapido(5000)">
                                    <span class="qtop"><i class="fas fa-hand-holding-usd"></i></span>
                                    <span class="qval">$5,000</span>
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- 3. Confirmación (solo cuando el input de monto perdió el foco) -->
                  <div class="col-12" #resumenElement *ngIf="cajaSeleccionada && monederoSeleccionado && recargaForm.get('monto')?.value && !montoFocused">
                    <div class="confirm-card" *ngIf="mostrarResumen" [@slideDownFade] [@staggerFadeIn]>
                      <div class="confirm-head">
                        <div class="ch-left">
                          <div class="ch-ico">
                            <i class="fas fa-receipt"></i>
                          </div>
                          <div class="ch-txt">
                            <div class="ch-title">Confirmación</div>
                            <div class="ch-sub"><strong>Revisa los detalles antes de confirmar</strong></div>
                          </div>
                        </div>
                        <div class="ch-mark">
                          <i class="fas fa-lock"></i>
                          <span>Validado</span>
                        </div>
                      </div>

                      <div class="confirm-body">
                        <div class="row g-2">
                          <div class="col-12 col-md-4">
                            <div class="sum-tile">
                              <div class="st-top"><i class="fas fa-cash-register"></i><span>Caja</span></div>
                              <div class="st-main">{{ cajaSeleccionada.codigo || 'Sin registro' }}</div>
                              <div class="st-sub">{{ cajaSeleccionada.nombre || 'Sin registro' }}</div>
                            </div>
                          </div>

                          <div class="col-12 col-md-4">
                            <div class="sum-tile">
                              <div class="st-top"><i class="fas fa-wallet"></i><span>Monedero</span></div>
                              <div class="st-main">{{ monederoSeleccionado.numeroMonedero || 'Sin registro' }}</div>
                              <div class="st-sub">{{ monederoSeleccionado.alias || 'Sin registro' }}</div>
                            </div>
                          </div>

                          <div class="col-12 col-md-4">
                            <div class="sum-tile sum-tile-strong">
                              <div class="st-top"><i class="fas fa-coins"></i><span>Monto</span></div>
                              <div class="st-main st-main-big">{{ formatearMoneda(recargaForm.get('monto')?.value) }}</div>
                              <div class="st-sub">Carga inmediata</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="actions-bar mt-3">
                      <button type="button" class="btn-action-recarga btn-secondary" (click)="limpiarFormulario()">
                        <i class="fas fa-times"></i>
                        <span>Cancelar</span>
                      </button>

                      <button type="button" class="btn-action-recarga btn-primary" (click)="procesarRecarga()" [disabled]="recargaForm.invalid || procesando">
                        <i class="fas fa-check" *ngIf="!procesando"></i>
                        <i class="fas fa-spinner fa-spin" *ngIf="procesando"></i>
                        <span>{{ procesando ? 'Procesando...' : 'Confirmar Recarga' }}</span>
                      </button>
                    </div>
                  </div>

                  <!-- Acciones (solo Cancelar cuando no hay confirmación completa) -->
                  <div class="col-12" *ngIf="!cajaSeleccionada || !monederoSeleccionado || !recargaForm.get('monto')?.value || montoFocused">
                    <div class="actions-bar">
                      <button type="button" class="btn-action-recarga btn-secondary" (click)="limpiarFormulario()">
                        <i class="fas fa-times"></i>
                        <span>Cancelar</span>
                      </button>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>
